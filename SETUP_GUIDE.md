# DiddyMac Setup Guide

Complete setup instructions for the DiddyMac multi-agent communication system.

## Prerequisites

- Python 3.9 or higher
- OpenAI API key (with GPT-5 access)
- Composio API key
- Supabase account
- Zapier account (for WhatsApp, optional)

## Step 1: Install Dependencies

```bash
cd /Users/ritviksingh/Desktop/Ace148/DiddyMac
pip install -r requirements.txt
```

## Step 2: Environment Configuration

Create a `.env` file in the project root:

```bash
cp .env.example .env
```

Edit `.env` with your actual credentials:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_anon_or_service_key

# OpenAI Configuration  
OPENAI_API_KEY=sk-your-openai-api-key

# Composio Configuration
COMPOSIO_API_KEY=your_composio_api_key

# Zapier WhatsApp Webhook (Optional)
ZAPIER_WHATSAPP_WEBHOOK=https://hooks.zapier.com/hooks/catch/your_webhook_id
```

## Step 3: Supabase Database Setup

### Create Tables

Execute these SQL commands in your Supabase SQL editor:

#### input_db Table
```sql
create table public.input_db (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  "user" text null,
  source text null,
  input text null,
  subject text null,
  phone_number text null,
  constraint input_db_pkey primary key (id)
);

-- Enable Row Level Security (optional but recommended)
alter table public.input_db enable row level security;
```

#### rules_db Table
```sql
create table public.rules_db (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  rule_maker text null,
  rule_org text null,
  rule_instruction text null,
  constraint rules_db_pkey primary key (id)
);

-- Enable Row Level Security (optional but recommended)
alter table public.rules_db enable row level security;
```

### Setup Webhook (Optional - for real-time processing)

1. Go to Supabase Dashboard → Database → Webhooks
2. Create new webhook for `input_db` table
3. Event: `INSERT`
4. URL: `http://your-server:8000/` (or ngrok URL)
5. Method: `POST`

## Step 4: Composio Setup

Authenticate Composio and connect services:

```bash
# Login to Composio
composio login

# Connect Gmail
composio add gmail

# Connect Google Calendar
composio add googlecalendar

# Connect Google Meet (usually included with Calendar)
composio add googlemeets

# Connect Google Docs
composio add googledocs

# Verify connections
composio show apps
```

## Step 5: Test the System

### Option A: Direct Processing (Recommended for testing)

```bash
python main.py
```

This will run a test request and show the complete output.

### Option B: Webhook Server (For production)

```bash
python webhook_server.py
```

Server will start on `http://0.0.0.0:8000`

To test the webhook:
```bash
curl -X POST http://localhost:8000/ \
  -H "Content-Type: application/json" \
  -d '{
    "record": {
      "id": 1,
      "user": "test@example.com",
      "source": "email",
      "input": "Schedule a meeting with John tomorrow at 3pm",
      "subject": "Meeting Request",
      "created_at": "2025-01-01T12:00:00Z"
    }
  }'
```

## Step 6: WhatsApp Integration (Optional)

### Setup Zapier Webhook

1. Go to Zapier.com
2. Create new Zap
3. Trigger: "Webhooks by Zapier" → "Catch Hook"
4. Copy webhook URL to `.env` as `ZAPIER_WHATSAPP_WEBHOOK`
5. Action: "WhatsApp Business" → "Send Message"
6. Map fields:
   - Phone Number: `{{phone_number}}`
   - Message: `{{message}}`
7. Test and activate Zap

## Step 7: Verify Setup

Run health check:
```bash
curl http://localhost:8000/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "DiddyMac Communication Agent System",
  "timestamp": "2025-01-01T12:00:00.000000"
}
```

## Project Structure

```
DiddyMac/
├── agent_system/
│   ├── __init__.py
│   ├── memory_agent.py          # Intent classification & rule management
│   ├── orchestrator_agent.py    # Main orchestration with 4 agents
│   ├── subagents/
│   │   ├── __init__.py
│   │   ├── base_subagent.py     # Base class for all agents
│   │   ├── calendar_agent.py    # Google Calendar + Meet
│   │   ├── email_agent.py       # Gmail + Docs
│   │   ├── report_writer_agent.py # Google Docs
│   │   └── whatsapp_agent.py    # WhatsApp via Zapier
│   └── tools/
│       ├── __init__.py
│       └── whatsapp_zapier_tool.py # Custom WhatsApp function tool
├── config/
│   ├── __init__.py
│   └── agent_config.py          # Optimization profiles
├── utils/
│   ├── __init__.py
│   ├── supabase_client.py       # Database operations
│   ├── logger.py                # Logging system
│   ├── whatsapp_helper.py       # WhatsApp formatting
│   ├── message_utils.py         # Message utilities
│   ├── plan_manager.py          # Task planning
│   └── memory_storage.py        # Memory management
├── agent_memory/                # Runtime memory storage
│   ├── plans/
│   ├── context/
│   └── intermediate_results/
├── test_outputs/                # Test run logs
├── main.py                      # Main entry point
├── webhook_server.py            # Webhook server
├── requirements.txt             # Dependencies
├── .env                         # Environment variables (create this)
├── .env.example                 # Template
├── .gitignore                   # Git ignore rules
├── README.md                    # Project documentation
└── SETUP_GUIDE.md              # This file
```

## Usage Examples

### Example 1: Email Task
```json
{
  "user": "alice@company.com",
  "source": "email",
  "input": "Send email to team@company.com about Friday's meeting",
  "subject": "Team Update"
}
```

### Example 2: Calendar Task
```json
{
  "user": "bob@company.com",
  "source": "email",
  "input": "Schedule review meeting next Monday at 2pm with engineering team",
  "subject": "Review Meeting"
}
```

### Example 3: Rule Creation
```json
{
  "user": "alice@company.com",
  "source": "email",
  "input": "Remember to always CC john@company.com on project emails",
  "subject": "Preference"
}
```

### Example 4: WhatsApp Request
```json
{
  "user": "+14165551234",
  "source": "whatsapp",
  "input": "Create a project report and email it to stakeholders",
  "phone_number": "+14165551234"
}
```

## Troubleshooting

### Issue: "SUPABASE_URL not found"
**Solution**: Ensure `.env` file exists and contains valid credentials

### Issue: "Composio tools not found"
**Solution**: Run `composio add <toolkit>` for each service you need

### Issue: "GPT-5 model not available"
**Solution**: Ensure your OpenAI API key has GPT-5 access, or update model names in `config/agent_config.py` to use `gpt-4o` or `gpt-4o-mini`

### Issue: "WhatsApp messages not sending"
**Solution**: 
1. Verify Zapier webhook URL is correct
2. Check Zap is active and tested
3. Ensure phone numbers include `+` prefix

### Issue: "Import errors"
**Solution**: 
```bash
pip install -r requirements.txt --upgrade
```

## Production Deployment

### Using Gunicorn (Recommended)

```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8000 webhook_server:app
```

### Using ngrok (for testing webhooks locally)

```bash
ngrok http 8000
```

Use the ngrok URL as your Supabase webhook URL.

## Support

For issues or questions:
1. Check `test_outputs/` for detailed execution logs
2. Review error messages in console output
3. Verify all environment variables are set correctly

## Next Steps

After setup:
1. Test with simple email requests
2. Create some rules to see automatic application
3. Test WhatsApp integration (if configured)
4. Monitor `test_outputs/` for execution details
5. Adjust optimization profiles in `config/agent_config.py` if needed

---

**Note**: This system uses GPT-5 models. If you don't have access, update the model names in `config/agent_config.py` to use GPT-4o models instead.

